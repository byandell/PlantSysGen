---
title: "Statistical Models"
author: "Brian S. Yandell, UW-Madison"
date: "January 2017"
output:
  ioslides_presentation: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## does genotype influence phenotype?

Goals for genetic architecture

- Identify quantitative trait loci (QTL)
    + (and interactions among QTL)
- Interval estimates of QTL location
- Estimated QTL effects

Goals for genome-wide selection

- Predict breeding value of individuals
- Select best individuals

## PHE = GEN + ENV

phenotype = genotype + environment

- GEN = QTL + GWA
    + genotype = local + genome-wide genetic effects

- ENV = design + predictors + error
    + design structure (blocks, locations, ...)
    + predictor structure (soil additives, ...)
    + measurement error (independent)
    
<span style="font-size: 75%">Falconer & Mackay (1960--1996)</span>

## GEN = QTL + GWA

- QTL: quantitative trait loci
    + local to an identified genomic region
    + large Mendelian effects on mean
- GWA: genome-wide association
    + depends on population structure (kinship)
    + measures relationships away from QTL
    + average of many small effects

## PHE = QTL + GWA + ENV example

![](../Figs/phe_qtl.jpg)

## PHE = QTL + GWA + ENV example

![](../Figs/phe_gwa.jpg)

## PHE = QTL + GWA + ENV example

![](../Figs/phe_qtl_gwa.jpg)

## PHE = GWA + QTL * ENV example

![](../Figs/phe_qxe.jpg)

## PHE = QTL + GWA * ENV example

![](../Figs/phe_gxe.jpg)

## Pareto chart: from QTL to GWA

<img src="../Figs/pareto.jpg" alt="Pareto Diagram" style="width: 800px"/>

## Strategy for mapping

- Want to figure out what is going on
    + preliminary search: find important story
    + need strategies to uncover patterns
- Want to tell story in publication

- How to accomplish mapping goal
    + organic search for patterns
    + organize methods as you go
    + document steps (so you can redo)

## Challenges of models for experiments 

Simpler models yield clearer results

- compare 2 conditions 
- examine linear trend
- control for other factors

But reality may be more complicated

- masking of genetic effect (by background, etc.)
- subtle timing (when to measure)
- hard to measure key features (shape, quality)
- unknown details of processes under study

## Evolution of QTL models

original ideas focused on rare & costly markers  
models & methods refined as technology advanced

- single marker regression
- QTL (quantitative trait loci)
    + single locus models: interval mapping for QTL
    + multiple QTL models: epistasis
- GWA (genome-wide association mapping)
    + adjust for population structure
    + capture "missing heritability"
- multi-parent populations (MPP)

## Why study multiple traits?

- We may not know ...
    + how to measure (quality, shape, taste)
    + when to measure (development, season, kinetics)
    + what to measure (molecular pathways)
- We are interested in many things
    + individuals expensive
    + multiple measurements cheap (high throughput)
- pleiotropy vs close linkage
    + traits influenced by one cause or linkage drag?
    + untangle genetics and environment

## Multiple traits and GxE

- same phenotype in multiple environments
    + does genetic response depend on environment?
    + comparing 2 (or more) environments
    + trends across a cline or gradient
- multiple phenotypes
    + does one trait affect others (directly)?
    + leveraging similar biological function
    + correlation and causalty models

## Phenotype data 

![](../Figs/Bnapus_pheno.jpg)

<span style="font-size: 75%">Satagopan JM, Yandell BS, Newton MA, Osborn TC (1996) Genetics</span>

## Genotype data

Genetic map

![](../Figs/Bnapus_map.jpg)

## Genotypes on chr N2

![](../Figs/Bnapus_genotype.jpg)

## Genotypes reordered by `flower4`

![](../Figs/Bnapus_genotype4.jpg)

## Marker regression (BC or DH)

<img src="../Figs/Bnapus_anova.jpg" 
  alt="anova" 
  style="width: 400px; float:right"/>

- Also known as ANOVA
- Split sample into groups
    + by genotype at marker
    + red = missing genotype
- Do a t-test or ANOVA
- Repeat for each marker

## Marker regression model

$$ y = \mu_m + e $$

- $y$ = phenotypic trait
- $m$ = marker genotype (0,1)
- $\mu_m$ = mean for genotype $m$
- $e$ = error = unexplained variation

Marker regression:

- fit model for each marker across genome
- pick most significant marker

## Pros & cons of marker regression

- Advantages
    + simple; no need for genetic map
    + easy to add covariates
    + easily extended to more complex models
    + ignores marker position on genome
- Disadvantages
    + excludse individuals with missing genotype data
    + imperfect information about QTL location
    + suffers in low density scans
    + only considers one QTL at a time

## Statistical structure

![](../Figs/structure_bw.jpg)

- missing data problem:  Markers $\longleftrightarrow$ QTL
- model selection problem: QTL, covariates $\longrightarrow$ phenotype

## Interval mapping (IM)

- Assume a single QTL model.
- posit each genome position $\lambda$, one at a time, as putative QTL
    + $q$ = genotypes at locus $\lambda$

$$ \texttt{pr}(y | q): y = \mu_q + e $$

- mixing proportions over flanking markers
$$ \texttt{pr}(q | m): \texttt{table of proportions}$$

- model is mixture over possible QTL genotypes $q$
- mixture of normals

<span style="font-size: 75%">Lander & Botstein (1989) Genetics</span>

## Genotype probabilities

<img src="../Figs/genoprob1_bw.jpg"
  style="width: 800px"/>

Calculate $pr(q|m)$ assuming

- No crossover interference
- No genotyping errors

Or use the hidden Markov model (HMM)} technology

- To allow for genotyping errors
- To incorporate dominant markers

## Genotype probabilities

<img src="../Figs/genoprob2_bw.jpg"
  style="width: 800px"/>

Calculate $pr(q|m)$ assuming

- No crossover interference
- No genotyping errors

Or use the hidden Markov model (HMM)} technology

- To allow for genotyping errors
- To incorporate dominant markers

## Genotype probabilities

<img src="../Figs/genoprob3_bw.jpg"
  style="width: 800px"/>

Calculate $pr(q|m)$ assuming

- No crossover interference
- No genotyping errors

Or use the hidden Markov model (HMM)} technology

- To allow for genotyping errors
- To incorporate dominant markers

## Genotype probabilities

<img src="../Figs/genoprob4_bw.jpg"
  style="width: 800px"/>

Calculate $pr(q|m)$ assuming

- No crossover interference
- No genotyping errors

Or use the hidden Markov model (HMM)} technology

- To allow for genotyping errors
- To incorporate dominant markers

## Genotype probabilities

<img src="../Figs/genoprob5_bw.jpg"
  style="width: 800px"/>

Calculate $pr(q|m)$ assuming

- No crossover interference
- No genotyping errors

Or use the hidden Markov model (HMM)} technology

- To allow for genotyping errors
- To incorporate dominant markers

## Genotype probabilities

<img src="../Figs/genoprob6_bw.jpg"
  style="width: 800px"/>

Calculate $pr(q|m)$ assuming

- No crossover interference
- No genotyping errors

Or use the hidden Markov model (HMM)} technology

- To allow for genotyping errors
- To incorporate dominant markers

## phenotype given unknown genotype

<img src="../Figs/mixtures_bw.jpg" 
  alt="mix" 
  style="width: 350px; float:right"/>

<img src="../Figs/mixchr.jpg" style="width: 300px"/>

$\texttt{pr}(y|m) = \sum \texttt{pr}(y|q)\texttt{pr}(q|m)$

- 2 markers separated by 20 cM
    + QTL closer to left marker
- phenotype distribution
    + given marker genotypes
- mixture components
    + dashed curves

## [interval mapping idea](http://www.biostat.wisc.edu/~kbroman/D3/em_alg/)

think marker regression with fuzzy groups

<img src="../Figs/em_alg_illustration.png" alt="Interactive EM illustration" style="width: 500px; float:left"/>

<img src="../Figs/Bnapus_anova.jpg" 
  alt="anova" 
  style="width: 250px; float:right"/>



## interval mapping (IM) details

QTL genotype given markers: $\texttt{pr}(q|m)$ 

phenotype given QTL: $\texttt{pr}(y|q)=N(y|\mu_q,\sigma^2)$ (normal density)

$$\texttt{pr}(y|m) = \sum_q \texttt{pr}(y|q)\texttt{pr}(q|m)$$

log likelihood over individuals:

$$l(\mu_0,\mu_1,\sigma) = \sum_i \log \texttt{pr}(y_i | m_i)$$

find $\hat{\mu}_0$, $\hat{\mu}_1$, $\hat{\sigma}$ to maximize $l(\mu_0,\mu_1,\sigma)$ (MLEs) 

## EM algorithm (Dempster et al.\ 1977)

**E step:** (pseudo)weights 
$$w_{iq} = \texttt{pr}(q|m_i,y_i,\hat{\mu},\hat{\sigma}) = C * \texttt{pr}(q|m_i)N(y_i|\hat{\mu}_q,\hat{\sigma})$$

**M step:** (pseudo)values: 

$$\hat{\mu}_q = \sum_i y_i w_{iq} / \sum_i w_{iq}$$

$$\hat{\sigma}^2 = \sum_i \sum_q w_{iq}
(y_i-\hat{\mu}_q)^2/n$$

**EM algorithm:** set $w_{iq} = \texttt{pr}(q|m_i)$; iterate E\&M to
converge

## LOD Scores

LOD score measures strength of evidence for QTL at locus $\lambda$  
$\log_{10}$ likelihood ratio of models:

- model with QTL at $\lambda$ (mean depends on QTL genotype $q$ at $\lambda$)
- model with no QTL (common mean for all individuals)

$$\texttt{lod}(\lambda) = [l(\hat{\mu}_{0\lambda}, \hat{\mu}_{1\lambda}, \hat{\sigma}_\lambda) - l(\hat{\mu}, \hat{\sigma})]/\log(10)$$

<hr> 

QTL model: means are MLEs $\hat{\mu}_{0\lambda}, \hat{\mu}_{1\lambda}$ with QTL at $\lambda$

No QTL model: mean is unconditional MLE $\hat{\mu}=\bar{y}$

SD computed given model means: $\hat{\sigma}_\lambda, \hat{\sigma}$

## Pros and Cons of IM

- Advantages
    + takes proper account of missing data
    + allows examination of positions between markers
    + gives improved estimates of QTL effects
    + provides pretty graphs (important!)
- Disadvantages
    + increased computation time
    + requires specialized software
    + difficult to generalize and extend
    + only one QTL at a time

## Multiple loci models

$$ y = \mu_q + e $$

$$ \mu_q = \mu(q_1, q_2, \cdots) = \mu+q_1\beta_1+q_2\beta_2+\cdots$$

- allows for multiple loci
- can add epistasis

$$ \mu_q  = \mu+q_1\beta_1+q_2\beta_2+q_{12}\gamma $$

## Shortcoming of multiple loci models

- only inlcudes significant loci
- but only include significant loci in practice
- selection bias: 
    + overestimate effects of included loci
    + many loci of small effect ignored ...

## GWA big idea

- Kinship via pedigree: all we had
    + average / predicted relationship
    + works globally, might be inaccurate locally
    + think maternal vs paternal twins
- Kinship via SNP/GBS
    + estimated from data
    + used to be selected to be neutral
    + now use all but away from QTL
- GWA measures ...
    + population structure
    + other genetic effects including other QTL

## Missing heritability (Eleazar Eskin)

Rewrite QTL genotype $q_j$ as $X_j$ with mean 0, variance 1 (depends on frequency of the genotype in population).

Only pick up significant QTL


$$ \mu_q  = \mu+\sum_{j=1}^k q_j\beta_j $$

but actual model has $K>k$ terms

$$ \mu_q  = \mu+\sum_{j=1}^K q_j\beta_j $$
